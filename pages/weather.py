import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os

# --------------------------------------------------------------------------------
# 1. ì„¤ì • ë° í•œê¸€ í°íŠ¸ ì´ìŠˆ ëŒ€ì‘ (ê·¸ë˜í”„ ê¹¨ì§ ë°©ì§€ ìœ„í•´ ì˜ë¬¸ ë¼ë²¨ ì‚¬ìš© ê¶Œì¥)
# --------------------------------------------------------------------------------
st.set_page_config(page_title="ê¸°ì˜¨ ì¶”ì„¸ ë¶„ì„", layout="wide")

st.title("ğŸŒ¡ï¸ ê¸°ì˜¨ ë°ì´í„° ì‹œê°í™” ë° ì¶”ì„¸ì„  ë¶„ì„")
st.markdown("ë°ì´í„° íŒŒì¼(`temperature_data.csv`)ì´ ê°™ì€ í´ë”ì— ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")

# --------------------------------------------------------------------------------
# 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (íŒŒì¼ì´ ì—†ìœ¼ë©´ ì˜ˆì‹œ ë°ì´í„° ìƒì„±)
# --------------------------------------------------------------------------------
file_name = 'pages/ta_20251213130855.csv'

@st.cache_data
def load_data():
    if os.path.exists(file_name):
        # íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸° (ì¸ì½”ë”©ì€ ìƒí™©ì— ë”°ë¼ 'cp949'ë‚˜ 'utf-8' ì‚¬ìš©)
        try:
            df = pd.read_csv(file_name, encoding='utf-8')
        except UnicodeDecodeError:
            df = pd.read_csv(file_name, encoding='cp949')
        return df
    else:
        # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì˜ˆì‹œ ë°ì´í„° ìƒì„± (ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ìš©)
        st.warning(f"âš ï¸ '{file_name}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤.")
        data = {
            'Year': range(2014, 2024),
            'Min': [-12.5, -13.0, -11.5, -12.8, -10.5, -9.8, -10.2, -8.5, -9.0, -7.5],
            'Max': [34.5, 35.2, 36.0, 35.8, 37.5, 36.8, 37.2, 38.0, 38.5, 39.1],
            'Avg': [12.5, 12.7, 12.9, 13.1, 13.4, 13.6, 13.8, 14.1, 14.3, 14.6]
        }
        return pd.DataFrame(data)

df = load_data()

# ì‚¬ìš©ì íŒŒì¼ì˜ ì»¬ëŸ¼ëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§¤í•‘ (í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”)
# ì˜ˆ: ì‚¬ìš©ìì˜ csv íŒŒì¼ ì»¬ëŸ¼ì´ 'ì—°ë„', 'í‰ê· ' ë“±ìœ¼ë¡œ ë˜ì–´ìˆë‹¤ë©´ ì•„ë˜ë¥¼ ìˆ˜ì •
col_year = 'Year'   # ì—°ë„ ì»¬ëŸ¼ëª…
col_min = 'Min'     # ì ˆëŒ€ ìµœì € ì»¬ëŸ¼ëª…
col_max = 'Max'     # ì ˆëŒ€ ìµœê³  ì»¬ëŸ¼ëª…
col_avg = 'Avg'     # í‰ê·  ê¸°ì˜¨ ì»¬ëŸ¼ëª…

# ë°ì´í„° í™•ì¸
with st.expander("ğŸ“„ ë°ì´í„° ì›ë³¸ ë³´ê¸°"):
    st.dataframe(df)

# --------------------------------------------------------------------------------
# 3. ì¶”ì„¸ì„  ê³„ì‚° (Numpy Polyfit ì‚¬ìš© - ë³„ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë¶ˆí•„ìš”)
# --------------------------------------------------------------------------------
# xì¶•: ì—°ë„, yì¶•: í‰ê·  ê¸°ì˜¨
x = df[col_year]
y = df[col_avg]

# 1ì°¨ ë°©ì •ì‹ (y = ax + b)ì˜ ê¸°ìš¸ê¸°(a)ì™€ ì ˆí¸(b) ê³„ì‚°
# ê¸°ìš¸ê¸°(slope)ê°€ ê³§ 'ì „ë…„ ëŒ€ë¹„ í‰ê·  ê¸°ì˜¨ ìƒìŠ¹ê°’'ì˜ ì¶”ì„¸ì…ë‹ˆë‹¤.
slope, intercept = np.polyfit(x, y, 1)

# ì¶”ì„¸ì„  í•¨ìˆ˜ ìƒì„±
trend_func = np.poly1d((slope, intercept))

# ìƒìŠ¹ê°’ ê³„ì‚° ê²°ê³¼ í‘œì‹œ
st.subheader("ğŸ“Š ë¶„ì„ ê²°ê³¼")
st.write(f"**í‰ê·  ê¸°ì˜¨ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•œ ì—°í‰ê·  ìƒìŠ¹ ì¶”ì„¸:** ì•½ `{slope:.4f} â„ƒ/ë…„`")
if slope > 0:
    st.write("ğŸ‘‰ ì „ë…„ ëŒ€ë¹„ ê¸°ì˜¨ì´ **ìƒìŠ¹**í•˜ëŠ” ì¶”ì„¸ì…ë‹ˆë‹¤.")
else:
    st.write("ğŸ‘‰ ì „ë…„ ëŒ€ë¹„ ê¸°ì˜¨ì´ **í•˜ê°•**í•˜ëŠ” ì¶”ì„¸ì…ë‹ˆë‹¤.")

# --------------------------------------------------------------------------------
# 4. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
# --------------------------------------------------------------------------------
fig, ax = plt.subplots(figsize=(12, 6))

# A. ì ˆëŒ€ ìµœì €ê°’ (íŒŒë€ìƒ‰ ì ì„ )
ax.plot(df[col_year], df[col_min], label='Absolute Min Temp', color='blue', linestyle='--', alpha=0.5)

# B. ì ˆëŒ€ ìµœê³ ê°’ (ì´ˆë¡ìƒ‰ ì ì„ )
ax.plot(df[col_year], df[col_max], label='Absolute Max Temp', color='green', linestyle='--', alpha=0.5)

# C. í‰ê·  ê¸°ì˜¨ê°’ (ê²€ì€ìƒ‰ ì‹¤ì„ )
ax.plot(df[col_year], df[col_avg], label='Average Temp', color='black', linewidth=1.5, marker='o')

# D. ì¶”ì„¸ì„  (ë¹¨ê°„ìƒ‰ ì‹¤ì„ ) - ìš”ì²­í•˜ì‹  ë¶€ë¶„
# í‰ê·  ê¸°ì˜¨ ìƒìŠ¹ê°’(ê¸°ìš¸ê¸°)ì— ë§ì¶° ê·¸ë ¤ì§
ax.plot(df[col_year], trend_func(x), label=f'Trend Line (Rise: {slope:.2f}/yr)', color='red', linewidth=3)

# ê·¸ë˜í”„ ê¾¸ë¯¸ê¸°
ax.set_title('Temperature Trend Analysis', fontsize=15)
ax.set_xlabel('Year')
ax.set_ylabel('Temperature (â„ƒ)')
ax.legend()
ax.grid(True, linestyle=':', alpha=0.6)

# Streamlitì— ê·¸ë˜í”„ ì¶œë ¥
st.pyplot(fig)
